load("@rules_cc//cc:cc_library.bzl", "cc_library")

package(default_visibility = ["//visibility:private"])

_BLOSC_LOCAL_DEFINES = [
    # This makes the BLOSC_NO_EXPORT macro, which would otherwise make internal
    # functions have hidden visibility, a no-op.  Hidden visibility isn't
    # compatible with using multiple cc_library rules to compile this library,
    # which is done in order to compile the AVX2 code with different compiler
    # options.
    "BLOSC_TESTING=1",
]

cc_library(
    name = "blosc",
    srcs = [
        "blosc/blosc.c",
        "blosc/blosclz.c",
        "blosc/blosclz.h",
        "blosc/fastcopy.c",
        "blosc/fastcopy.h",
        "blosc/shuffle.c",
        "blosc/shuffle.h",
    ],
    hdrs = [
        "blosc/blosc.h",
        "blosc/blosc-export.h",
    ],
    copts = select({
        "@rules_cc//cc/compiler:msvc-cl": [],
        "//conditions:default": [
            "-Wno-unused-but-set-variable",
            "-Wno-unused-function",
        ],
    }),
    implementation_deps = [
        ":shuffle_common",
        "@lz4",
        "@snappy//:snappy-c",
        "@zlib",
        "@zstd",
    ] + select(
        {
            "@platforms//os:windows": [":win32"],
            "//conditions:default": [],
        },
    ) + select({
        "@platforms//cpu:x86_64": [
            ":shuffle_avx2",
            ":shuffle_sse2",
        ],
        "//conditions:default": [],
    }),
    local_defines = _BLOSC_LOCAL_DEFINES + [
        "HAVE_ZLIB",
        "HAVE_LZ4",
        "HAVE_ZSTD",
        "HAVE_SNAPPY",
    ] + select({
        "@platforms//cpu:x86_64": [
            "SHUFFLE_SSE2_ENABLED",
            # Always build AVX2 support.  It is only used at runtime if the CPU
            # supports it.
            "SHUFFLE_AVX2_ENABLED",
        ],
        "//conditions:default": [],
    }),
    strip_include_prefix = "blosc",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "shuffle_common",
    srcs = [
        "blosc/bitshuffle-generic.c",
        "blosc/shuffle-generic.c",
    ],
    hdrs = [
        "blosc/bitshuffle-generic.h",
        "blosc/blosc-common.h",
        "blosc/blosc-comp-features.h",
        "blosc/blosc-export.h",
        "blosc/shuffle-generic.h",
    ],
    local_defines = _BLOSC_LOCAL_DEFINES,
    strip_include_prefix = "blosc",
)

cc_library(
    name = "shuffle_sse2",
    srcs = [
        "blosc/bitshuffle-sse2.c",
        "blosc/shuffle-sse2.c",
    ],
    hdrs = [
        "blosc/bitshuffle-sse2.h",
        "blosc/shuffle-sse2.h",
    ],
    copts = select({
        "@rules_cc//cc/compiler:msvc-cl": ["/arch:SSE2"],
        "//conditions:default": ["-msse2"],
    }),
    includes = ["blosc"],
    local_defines = _BLOSC_LOCAL_DEFINES,
    target_compatible_with = ["@platforms//cpu:x86_64"],
    deps = [
        ":shuffle_common",
    ],
)

cc_library(
    name = "shuffle_avx2",
    srcs = [
        "blosc/bitshuffle-avx2.c",
        "blosc/shuffle-avx2.c",
    ],
    hdrs = [
        "blosc/bitshuffle-avx2.h",
        "blosc/shuffle-avx2.h",
    ],
    copts = select({
        "@rules_cc//cc/compiler:msvc-cl": ["/arch:AVX2"],
        "//conditions:default": ["-mavx2"],
    }),
    includes = ["blosc"],
    local_defines = _BLOSC_LOCAL_DEFINES,
    target_compatible_with = ["@platforms//cpu:x86_64"],
    deps = [
        ":shuffle_common",
        ":shuffle_sse2",
    ],
)

cc_library(
    name = "win32",
    srcs = [
        "blosc/win32/pthread.c",
    ],
    hdrs = [
        "blosc/win32/pthread.h",
        "blosc/win32/stdint-windows.h",
    ],
    target_compatible_with = ["@platforms//os:windows"],
)
