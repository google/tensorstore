load("@tensorstore//bazel:utils.bzl", "package_relative_path")

package(default_visibility = ["//visibility:public"])

ZSTD_SRCS = glob(
    [
        "lib/*.h",
        "lib/common/*.h",
        "lib/common/*.c",
        "lib/compress/*.h",
        "lib/compress/*.c",
        "lib/decompress/*.h",
        "lib/decompress/*.c",
    ],
    exclude = ["lib/zstd.h"],
)

LOCAL_DEFINES = [
    "XXH_NAMESPACE=ZSTD_",
] + select({
    ":zstd_asm_supported": [],
    "//conditions:default": ["ZSTD_DISABLE_ASM=1"],
})

cc_library(
    name = "zstd",
    srcs = ZSTD_SRCS +
           select({
               ":zstd_asm_supported": ["lib/decompress/huf_decompress_amd64.S"],
               "//conditions:default": [],
           }),
    hdrs = ["lib/zstd.h"],
    copts = ["-I" + package_relative_path("lib/common")],
    defines = [
        # Since this rule is used to build a static library, prevent ZSTD from
        # overriding global `-fvisibility=hidden` setting.
        "ZSTDLIB_VISIBLE=",
        "ZSTDLIB_HIDDEN=",
    ],
    includes = ["lib"],
    local_defines = LOCAL_DEFINES,
)

# Constraint that indicates whether asm is supported by zstd
alias(
    name = "zstd_asm_supported",
    actual = select({
        # Disable for msvc.
        "@rules_cc//cc/compiler:msvc-cl": "@platforms//:incompatible",

        # Enable condition on x86_64.
        "//conditions:default": "@platforms//cpu:x86_64",
    }),
)
